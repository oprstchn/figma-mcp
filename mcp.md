# Model Context Protocol (MCP) 仕様

## 概要

Model Context Protocol (MCP) は、LLMアプリケーションとコンテキスト提供サーバー間の標準化された通信プロトコルです。このプロトコルにより、LLMとのインタラクションの懸念からコンテキスト提供の懸念を分離し、柔軟で拡張可能なアーキテクチャを実現します。

## コアアーキテクチャ

MCPはクライアント-サーバーアーキテクチャに基づいています：

- **ホスト**: LLMアプリケーション（Claude DesktopやIDEなど）で、接続を開始します
- **クライアント**: サーバーとの1:1の接続を維持し、ホストアプリケーション内に存在します
- **サーバー**: クライアントにコンテキスト、ツール、プロンプトを提供します

```
+----------------+                 +------------------+
|      Host      |                 | Server Process   |
|                |                 |                  |
|  +----------+  |  Transport      |  +-----------+   |
|  |MCP Client|<-|------ Layer --->|->|MCP Server |   |
|  +----------+  |                 |  +-----------+   |
|                |                 |                  |
+----------------+                 +------------------+
```

## プロトコルレイヤー

プロトコルレイヤーはメッセージのフレーミング、リクエスト/レスポンスのリンク、高レベルの通信パターンを処理します。MCPはJSON-RPCベースのプロトコルを使用し、以下の主要な機能を提供します：

- リクエスト送信と応答待機
- 一方向通知の送信
- 着信リクエストの処理
- 着信通知の処理

## コアコンポーネント

### リソース

リソースはLLMにデータを公開する方法です。RESTのGETエンドポイントに似ており、データを提供しますが、重要な計算や副作用を持つべきではありません。

- **静的リソース**: 固定URIを持つリソース
- **動的リソース**: パラメータを含むテンプレートURIを持つリソース
- **リソースリスト**: 利用可能なリソースの一覧を提供

リソースURIは特定のスキーマに従い、通常は `scheme://path` の形式です。

### ツール

ツールはLLMがサーバーを通じてアクションを実行できるようにします。リソースとは異なり、ツールは計算を実行し、副作用を持つことが期待されます。

- パラメータを持つシンプルなツール
- 外部APIを呼び出す非同期ツール
- 複雑な操作を実行するツール

### プロンプト

プロンプトは、LLMがサーバーと効果的にやり取りするための再利用可能なテンプレートです。これにより、特定のタスクやインタラクションパターンのための標準化された方法を提供します。

### トランスポート

MCPは複数のトランスポートレイヤーをサポートしています：

- **stdio**: 標準入出力を使用した通信
- **HTTP with SSE**: HTTPとServer-Sent Eventsを使用した通信
- **InMemory**: テスト用のメモリ内トランスポート

## メッセージ形式

MCPはJSON-RPC 2.0をベースにしたメッセージ形式を使用します。主なメッセージタイプは：

- **リクエスト**: メソッド名、パラメータ、IDを含む
- **レスポンス**: 結果または誤り、対応するリクエストIDを含む
- **通知**: レスポンスを期待しない一方向メッセージ

## エラー処理

MCPは標準化されたエラーコードとメッセージを使用します：

- パースエラー
- 無効なリクエスト
- メソッドが見つからない
- 無効なパラメータ
- 内部エラー
- サーバーエラー

## 認証

MCPは複数の認証メカニズムをサポートしています：

- アクセストークン
- OAuth2
- カスタム認証スキーム

## バージョニング

MCPは明示的なバージョニングをサポートしています：

- 最新プロトコルバージョン: "2024-11-05"
- サポートされているプロトコルバージョン: ["2024-11-05", "2024-10-07"]
- JSON-RPCバージョン: "2.0"

## 実装ガイドライン

### サーバー実装

サーバーは以下の機能を提供する必要があります：

1. リソース、ツール、プロンプトの登録と管理
2. クライアントからのリクエスト処理
3. 適切なレスポンスの生成
4. エラー処理とログ記録

### クライアント実装

クライアントは以下の機能を提供する必要があります：

1. サーバーへの接続管理
2. リクエストの送信と応答の処理
3. 通知の送信と受信
4. エラー処理とリトライロジック

## 拡張性

MCPは拡張可能に設計されており、以下の方法で拡張できます：

1. 新しいリソースタイプの追加
2. 新しいツールの実装
3. カスタムプロンプトの定義
4. 新しいトランスポートレイヤーの追加

## セキュリティ考慮事項

MCPを実装する際は、以下のセキュリティ考慮事項に注意する必要があります：

1. 適切な認証と認可
2. 入力の検証とサニタイズ
3. レート制限と使用量の監視
4. 機密データの保護

## Figma APIとの統合

Figma APIをModel Context Protocolと統合する際は、以下の点に注意する必要があります：

1. Figmaのデータモデルをリソースとして適切にマッピング
2. Figma APIの認証をMCP認証と統合
3. Figmaの操作をMCPツールとして実装
4. Figmaのイベントをリアルタイム通知として処理

## 参考実装

TypeScript SDKは、MCPの公式参考実装として提供されています。このSDKは以下の機能を提供します：

1. MCPクライアントとサーバーの完全な実装
2. 標準トランスポート（stdio、HTTP with SSE）のサポート
3. リソース、ツール、プロンプトの簡単な登録と管理
4. 型安全なAPIとエラー処理
